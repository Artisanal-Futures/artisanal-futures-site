import dynamic from "next/dynamic";
import Head from "next/head";
import { useEffect, useState } from "react";

import { ArrowRight } from "lucide-react";

import DriverSheet from "~/apps/solidarity-routing/components/drivers/driver-sheet";
import DriversDynamicTab from "~/apps/solidarity-routing/components/drivers/drivers-tab";
import FulfillmentSheet from "~/apps/solidarity-routing/components/stops/fulfillment-sheet";
import StopsDynamicTab from "~/apps/solidarity-routing/components/stops/stops-tab";
import CalculationsTab from "~/components/tools/routing/solutions/calculations-tab";
import BottomSheet from "~/components/tools/routing/ui/bottom-sheet";
import { Button } from "~/components/ui/button";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "~/components/ui/tabs";

import RouteLayout from "~/layouts/route-layout";

import { useDrivers } from "~/apps/solidarity-routing/hooks/use-drivers";
import { useStops } from "~/apps/solidarity-routing/hooks/use-stops";
import useRouteOptimization from "~/hooks/routing/use-route-optimization";

const LazyRoutingMap = dynamic(
  () => import("~/components/tools/routing/map/routing-map"),
  {
    ssr: false,
    loading: () => <div>loading...</div>,
  }
);
/**
 * Page component that allows users to generate routes based on their input.
 */
const RoutingPage = () => {
  const [tabValue, setTabValue] = useState("plan");

  const { locations } = useStops((state) => state);
  const { drivers } = useDrivers((state) => state);

  useEffect(() => {
    void useStops.persist.rehydrate();
    void useDrivers.persist.rehydrate();
  }, []);

  const { getRoutes } = useRouteOptimization();

  const calculateOptimalPaths = () => {
    setTabValue("calculate");
    void getRoutes();
  };

  const openTrackingPage = () =>
    window.open("/tools/routing/tracking", "_blank");

  const isRouteDataMissing = locations.length === 0 || drivers.length === 0;

  return (
    <>
      <Head>
        <title>Routing Optimization | Artisanal Futures</title>
        <meta name="description" content="Generated by create-t3-app" />{" "}
        <meta
          name="viewport"
          content="width=device-width,height=device-height initial-scale=1"
        />
        <link rel="icon" href="/favicon.ico" />{" "}
      </Head>

      <FulfillmentSheet />
      <DriverSheet />

      <RouteLayout>
        <section className="flex flex-1  flex-col-reverse border-2 max-md:h-full lg:flex-row">
          <Tabs
            defaultValue="plan"
            value={tabValue}
            onValueChange={setTabValue}
            className="flex w-full flex-col gap-4 max-lg:hidden max-lg:h-4/6 lg:w-5/12 xl:w-3/12"
          >
            <TabsList className=" flex ">
              <TabsTrigger value="plan" className="w-full">
                Plan
              </TabsTrigger>
              <TabsTrigger
                value="calculate"
                className="w-full"
                disabled={isRouteDataMissing}
                onClick={calculateOptimalPaths}
              >
                Calculate
              </TabsTrigger>{" "}
              <Button
                className="w-full"
                variant={"ghost"}
                disabled={isRouteDataMissing}
                onClick={openTrackingPage}
              >
                Track
              </Button>
            </TabsList>
            <TabsContent value="plan" asChild>
              <>
                <DriversDynamicTab />
                <StopsDynamicTab />
                <div className=" flex h-16 items-center justify-end bg-white p-4">
                  <Button
                    onClick={() => {
                      setTabValue("calculate");
                      void getRoutes();
                    }}
                    className="gap-2"
                    disabled={isRouteDataMissing}
                  >
                    Calculate Routes <ArrowRight />
                  </Button>
                </div>
              </>
            </TabsContent>
            <TabsContent value="calculate" asChild>
              <>
                <CalculationsTab />
                <div className=" flex h-16 items-center justify-end bg-white p-4">
                  <Button
                    onClick={calculateOptimalPaths}
                    className="gap-2"
                    disabled={locations.length === 0 || drivers.length === 0}
                  >
                    Calculate Routes <ArrowRight />
                  </Button>
                </div>
              </>
            </TabsContent>
          </Tabs>
          <div className="flex lg:hidden">
            <BottomSheet title="Plan">
              <DriversDynamicTab />
              <StopsDynamicTab />
            </BottomSheet>

            <BottomSheet
              title="Calculate"
              isDisabled={locations.length === 0 || drivers.length === 0}
              handleOnClick={calculateOptimalPaths}
            >
              <CalculationsTab />
            </BottomSheet>

            <Button
              className="w-full"
              variant={"ghost"}
              disabled={isRouteDataMissing}
              onClick={openTrackingPage}
            >
              Track
            </Button>
          </div>
          <LazyRoutingMap className="max-md:aspect-square lg:w-7/12 xl:w-9/12" />
        </section>
      </RouteLayout>
    </>
  );
};

export default RoutingPage;
